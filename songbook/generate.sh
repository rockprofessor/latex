#!/bin/bash

# Start the LaTeX document
echo "% Autogenerated Songbook"
echo "\documentclass[a4paper,12pt]{article}"
echo "\usepackage[T1]{fontenc}"
echo "\usepackage[utf8]{inputenc}"
echo "\usepackage[lmargin=2cm, rmargin=2cm, tmargin=1.25cm, bmargin=1.5cm]{geometry}" # Smaller margins
echo "\usepackage{lmodern}"
echo "\usepackage{listings}"
echo "\usepackage{titlesec}"                                   # Reduce spacing before/after sections
echo "\usepackage{setspace}"                                   # Fine-tune line spacing
echo "\usepackage{hyperref}"                                   # Enable clickable links
echo "\hypersetup{colorlinks=true, linkcolor=blue, hidelinks}" # Clickable but without boxes
echo "\usepackage{tocloft}"                                    # Package to customize TOC
echo "\setlength{\cftbeforesecskip}{1pt}"                      # Reduce line spacing in TOC
echo "\renewcommand{\cftsecleader}{\cftdotfill{\cftdotsep}}"   # Add dots between entry and page number
echo "\setlength{\footskip}{6pt} % Reduce space between text and footer"
echo "\setlength{\cftsecnumwidth}{0em}" # Set width of section number in TOC
echo "\setlength{\cftsecindent}{3em}"   # Set indentation of section titles in TOC

# Reduce line spacing even more
echo "\linespread{0.7}"
echo "\titleformat{\section}[block]{\normalfont\large\bfseries}{}{0pt}{}"
echo "\titlespacing{\section}{0pt}{2pt}{2pt}" # Reduce space around section titles

# Title of the Songbook
echo "\title{The Ultimate Guitar Songbook}"
echo "\author{Robert Machovec}"
echo "\date{\today}"
echo "\begin{document}"
echo "\maketitle"

# Change Table of Contents heading
echo "\renewcommand{\contentsname}{Setlist}"
echo "\tableofcontents"

echo "\newpage"
#echo "\section*{Songs}"

# lstlisting settings for proper page breaks on empty lines
echo "\lstset{"
echo "  basicstyle=\small\ttfamily,"
echo "  breaklines=true,"        # Allow line breaking
echo "  breakatwhitespace=true," # Only break at whitespace (empty lines)
echo "  prebreak=\mbox{},"       # Prevents breaking in the middle of a word
echo "  keepspaces=true,"        # Keeps formatting of spaces
echo "  postbreak=\mbox{},"      # Prevents breaking in the middle of a word
echo "  inputencoding=utf8,"
echo "  extendedchars=true,"

echo "}"

echo "\lstset{literate=%"
echo "  {Ö}{{\"O}}1"
echo "  {Ä}{{\"A}}1"
echo "  {Ü}{{\"U}}1"
echo "  {ß}{{\ss}}1"
echo "  {ü}{{\"u}}1"
echo "  {ä}{{\"a}}1"
echo "  {ö}{{\"o}}1"
echo "}"

# Sort files alphabetically and loop through them
for file in $(ls songs/*.txt | sort); do
    filename=$(basename -- "$file" .txt)          # Remove path and extension
    bandname=$(echo "$filename" | cut -d'-' -f1)  # Extract band name
    songname=$(echo "$filename" | cut -d'-' -f2-) # Extract song name

    # Replace underscores with spaces for display purposes
    bandname=$(echo "$bandname" | tr '_' ' ')
    songname=$(echo "$songname" | tr '_' ' ')

    # Ensure LaTeX properly displays the section title in monospace font
    echo "\phantomsection"                           # Ensure correct hyperlink target
    echo "\section*{\texttt{$bandname - $songname}}" # Display as monospace text

    # Add clickable entry in TOC with monospace font
    echo "\addcontentsline{toc}{section}{\texorpdfstring{\texttt{$bandname - $songname}}{$bandname - $songname}}"

    # Include song content, which will automatically break pages on empty lines
    echo "\lstinputlisting{$file}"
    # Process the song file to make lines ending with ':' bold
    echo "\newpage" # Add page break after each song
done

# End the LaTeX document
echo "\end{document}"
